<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage User</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/buttons/1.1.2/css/buttons.dataTables.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/select/1.1.2/css/select.dataTables.min.css" rel="stylesheet">
  <link href="http://cdn.datatables.net/responsive/2.0.2/css/responsive.dataTables.min.css" rel="stylesheet">

  <link rel="stylesheet" href="./styles/manageUser.css" /></head>
  <body>
    <div class="cover">
        <div class="sidePane">
          <!--<img class="dnxLogo" alt="Logo" src="/home/shivom/Downloads/logo.png" />-->
          <img class="dnxLogo" alt="Logo" src="./images/inno_facex.png" />
          <form class="adminLoginForm" action="/test" method="POST" enctype="multipart/form-data">
              <div class="form-group adminLogin">
                <div class="heading">Add User Form</div>
                
                <label for="name">Name</label>
                <input class="form-control" name="name" id="name" placeholder="Name" type="text" required />
                
                <label for="email">Email</label>
                <input class="form-control" name="email" id="email" placeholder="Email" type="email" required />
                
                <label for="empId">Employee Id</label>
                <input class="form-control" name="empId" id="empId" placeholder="Employee Id" type="text" required />
          
                <label for="phone">Phone Number</label>
                <input class="form-control" name="phone" id="phone" placeholder="Phone Number" type="phone" pattern="[0-9]{10}" required />

                <label for="photo">Upload Photos</label>
                <input class="form-control" name="photo" id="photo" placeholder="Upload photos" type="file" required multiple accept="image/jpg,image/png,image/jpeg,image/gif"/>
          
                <!-- <label for="inputPassword">Password</label> <input class="form-control" id="inputPassword" placeholder="Password" type="password" /> -->
                <button class="btn btn-primary login1" type="submit">Add User</button>
              </div>
            </form>
        </div>
        <div class="mainPane">
          <div class="heading">DNX Attendance Portal</div>
          <div class="container">
              <table cellpadding="0" cellspacing="0" border="0" class="dataTable table table-striped" id="dnxTable">
            
              </table>
            </div>
        </div>
      </div>


</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
  
  <script src="http://cdn.datatables.net/responsive/2.0.2/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.1.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/select/1.1.2/js/dataTables.select.min.js"></script>


</html>

<script>

 (function( factory ){
    if ( typeof define === 'function' && define.amd ) {
        // AMD
        define( ['jquery', 'datatables.net'], function ( $ ) {
            return factory( $, window, document );
        } );
    }
    else if ( typeof exports === 'object' ) {
        // CommonJS
        module.exports = function (root, $) {
            if ( ! root ) {
                root = window;
            }

            if ( ! $ || ! $.fn.dataTable ) {
                $ = require('datatables.net')(root, $).$;
            }

            return factory( $, root, root.document );
        };
    }
    else {
        // Browser
        factory( jQuery, window, document );
    }
}(function( $, window, document, undefined ) {
   'use strict';
   var DataTable = $.fn.dataTable;


   var _instance = 0;

   /** 
    * altEditor provides modal editing of records for Datatables
    *
    * @class altEditor
    * @constructor
    * @param {object} oTD DataTables settings object
    * @param {object} oConfig Configuration object for altEditor
    */
   var altEditor = function( dt, opts )
   {
       if ( ! DataTable.versionCheck || ! DataTable.versionCheck( '1.10.8' ) ) {
           throw( "Warning: altEditor requires DataTables 1.10.8 or greater");
       }

       // User and defaults configuration object
       this.c = $.extend( true, {},
           DataTable.defaults.altEditor,
           altEditor.defaults,
           opts
       );

       /**
        * @namespace Settings object which contains customisable information for altEditor instance
        */
       this.s = {
           /** @type {DataTable.Api} DataTables' API instance */
           dt: new DataTable.Api( dt ),

           /** @type {String} Unique namespace for events attached to the document */
           namespace: '.altEditor'+(_instance++)
       };


       /**
        * @namespace Common and useful DOM elements for the class instance
        */
       this.dom = {
           /** @type {jQuery} altEditor handle */
           modal: $('<div class="dt-altEditor-handle"/>'),
       };


       /* Constructor logic */
       this._constructor();
   }



   $.extend( altEditor.prototype, {
       /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        * Constructor
        * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

       /**
        * Initialise the RowReorder instance
        *
        * @private
        */
       _constructor: function ()
       {
           // console.log('altEditor Enabled')
           var that = this;
           var dt = this.s.dt;
           
           this._setup();

           dt.on( 'destroy.altEditor', function () {
               dt.off( '.altEditor' );
               $(dt.table().body()).off( that.s.namespace );
               $(document.body).off( that.s.namespace );
           } );
       },

       /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        * Private methods
        * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

       /**
        * Setup dom and bind button actions
        *
        * @private
        */
       _setup: function()
       {
         // console.log('Setup');

         var that = this;
         var dt = this.s.dt;

         // add modal
         $('body').append('\
            <div class="modal fade" id="altEditor-modal" tabindex="-1" role="dialog">\
              <div class="modal-dialog">\
                <div class="modal-content">\
                  <div class="modal-header">\
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                    <h4 class="modal-title"></h4>\
                  </div>\
                  <div class="modal-body">\
                    <p></p>\
                  </div>\
                  <div class="modal-footer">\
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
                    <button type="button" class="btn btn-primary">Save changes</button>\
                  </div>\
                </div>\
              </div>\
            </div>'
         );


         // add Edit Button
         if( this.s.dt.button('edit:name') )
         {
            this.s.dt.button('edit:name').action( function(e, dt, node, config) {
              var rows = dt.rows({
                selected: true
              }).count();

              that._openEditModal();
            });

            $(document).on('click', '#editRowBtn', function(e)
            {
              e.preventDefault();
              e.stopPropagation();
              that._editRowData();
            });

          }

        

       },

       /**
        * Emit an event on the DataTable for listeners
        *
        * @param  {string} name Event name
        * @param  {array} args Event arguments
        * @private
        */
       _emitEvent: function ( name, args )
       {
           this.s.dt.iterator( 'table', function ( ctx, i ) {
               $(ctx.nTable).triggerHandler( name+'.dt', args );
           } );
       },

       /**
        * Open Edit Modal for selected row
        * 
        * @private
        */
       _openEditModal: function ( )
       {
         var that = this;
         var dt = this.s.dt;

         var columnDefs = [];

         for( var i = 0; i < dt.context[0].aoColumns.length; i++ )
         {
            columnDefs.push({ title: dt.context[0].aoColumns[i].sTitle })
         }

          var adata = dt.rows({
            selected: true
          });
          console.log('adata');
          console.log(adata.data()[0]);
          this.dataBeforeEdit = adata.data()[0];
          console.log('data before edit. ',this.dataBeforeEdit);



          var data = "";

          data += "<form name='altEditor-form' role='form'>";
          var disabled = '';
          for (var j in columnDefs) {
            //since employee Id is third in array, this will need to be changed later
            if(j==2) {
              disabled = 'disabled';
            } else {
              disabled = '';
            }
            data += "<div class='form-group'><div class='col-sm-3 col-md-3 col-lg-3 text-right' style='padding-top:7px;'><label for='" + columnDefs[j].title + "'>" + columnDefs[j].title + ":</label></div><div class='col-sm-9 col-md-9 col-lg-9'><input type='text' "+ disabled +"  id='" + columnDefs[j].title + "' name='" + columnDefs[j].title + "' placeholder='" + columnDefs[j].title + "' style='overflow:hidden'  class='form-control  form-control-sm' value='" + adata.data()[0][j] + "'></div><div style='clear:both;'></div></div>";
          }
          data += "</form>";


          $('#altEditor-modal').on('show.bs.modal', function() {
            $('#altEditor-modal').find('.modal-title').html('Edit Record');
            $('#altEditor-modal').find('.modal-body').html('<pre>' + data + '</pre>');
            $('#altEditor-modal').find('.modal-footer').html("<button type='button' data-content='remove' class='btn btn-default' data-dismiss='modal'>Close</button>\
               <button type='button' data-content='remove' class='btn btn-primary' id='editRowBtn'>Save Changes</button>");
          });

          $('#altEditor-modal').modal('show');
          $('#altEditor-modal input[0]').focus();

       },

       _editRowData: function()
       {
         var that = this;
         console.log('inside this._editRowData function ', this.dataBeforeEdit);
         var dt = this.s.dt;
         var data = [];
         $('form[name="altEditor-form"] input').each(function( i )
         {
            data.push( $(this).val() );
         });        

         $('#altEditor-modal .modal-body .alert').remove();

         var message = '<div class="alert alert-success" role="alert">\
             <strong>Success!</strong> This record has been updated.\
           </div>';

           $('#altEditor-modal .modal-body').append(message);
           var updateUserLocally = function(data) {
            $('#dnxTable').DataTable().clear().destroy();
            createTable();
            // this.s.dt.row({ selected:true }).data(data);
           }
           this.dataBeforeEdit.forEach((e,i)=> {
             if(e != data[i]) {
               let url = 'https://192.168.1.12:2000/edit_data'
              //  $.ajax({
              //     type: "POST",
              //     url: url,
              //     data: {"imageURL": encodeURI(dataURL)},
              //     statusCode: {
              //         200: function (data) {
              //             if(confirm(data)) {
              //                 window.location.href = "/success";
              //             }
              //         },
              //         201: function (data) {
              //             alert(data)
              //         }
              //     }
              // });
              console.log('sending body ',data);
              fetch(url, {
                method: "POST", 
                mode: "cors", // no-cors, cors, *same-origin
                cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
                credentials: "same-origin", // include, *same-origin, omit
                headers: {
                    "Content-Type": "application/json",
                    // "Content-Type": "application/x-www-form-urlencoded",
                },
                redirect: "follow", // manual, *follow, error
                referrer: "no-referrer", // no-referrer, *client
                body: JSON.stringify(data), // body data type must match "Content-Type" header
              })
                .then(console.log);
            }
            });
           dt.row({ selected:true }).data(data);
              console.log('updated data', data);
          },



       _getExecutionLocationFolder: function() {
             var fileName = "dataTables.altEditor.js";
             var scriptList = $("script[src]");
             var jsFileObject = $.grep(scriptList, function(el) {

                  if(el.src.indexOf(fileName) !== -1 )
                  {
                     return el;
                  }
             });
             var jsFilePath = jsFileObject[0].src;
             var jsFileDirectory = jsFilePath.substring(0, jsFilePath.lastIndexOf("/") + 1);
             return jsFileDirectory;
         }
   } );



   /**
    * altEditor version
    * 
    * @static
    * @type      String
    */
   altEditor.version = '1.0';


   /**
    * altEditor defaults
    * 
    * @namespace
    */
   altEditor.defaults = {
       /** @type {Boolean} Ask user what they want to do, even for a single option */
       alwaysAsk: false,

       /** @type {string|null} What will trigger a focus */
       focus: null, // focus, click, hover

       /** @type {column-selector} Columns to provide auto fill for */
       columns: '', // all

       /** @type {boolean|null} Update the cells after a drag */
       update: null, // false is editor given, true otherwise

       /** @type {DataTable.Editor} Editor instance for automatic submission */
       editor: null
   };


   /**
    * Classes used by altEditor that are configurable
    * 
    * @namespace
    */
   altEditor.classes = {
       /** @type {String} Class used by the selection button */
       btn: 'btn'
   };


   // Attach a listener to the document which listens for DataTables initialisation
   // events so we can automatically initialise
   $(document).on( 'preInit.dt.altEditor', function (e, settings, json) {
       if ( e.namespace !== 'dt' ) {
           return;
       }

       var init = settings.oInit.altEditor;
       var defaults = DataTable.defaults.altEditor;

       if ( init || defaults ) {
           var opts = $.extend( {}, init, defaults );

           if ( init !== false ) {
               new altEditor( settings, opts  );
           }
       }
   } );


   // Alias for access
   DataTable.altEditor = altEditor;

   return altEditor;
}));</script>
<script>
function createTable() {
    fetch('https://192.168.1.12:2000/fetch_data',{
      mode: 'cors',
      headers: {
        'Access-Control-Allow-Origin':'*'
        }
    }).then(data=>data.json())
      .then((data) => {
        console.log('data fetched from local server',data);
        var columnDefs = [{
          title: "Name"
        }, {
          title: "Email"
        }, {
          title: "Employee Id"
        }, {
          title: "Phone Number"
        }];

        var myTable;

        myTable = $('#dnxTable').DataTable({
      "sPaginationType": "full_numbers",
      data: data,
      columns: columnDefs,
      dom: 'Bfrtip',        // Needs button container
            select: 'single',
            responsive: true,
            altEditor: true,     // Enable altEditor
            buttons: [
              {
                extend: 'selected', // Bind to Selected row
                text: 'Edit',
                name: 'edit'        // do not change name
              },
              ]
    });
      })

  }
$(document).ready(function() {
  createTable();
});

</script>
<style>
*{box-sizing:border-box;margin:0;padding:0;outline:0}html body{background-color:#fff;color:#666;font-family:Helvetica Neue,Helvetica,Arial,sans-serif}html body .cover{display:grid;grid-template-columns:360px auto}html body .cover .sidePane .dnxLogo{width:48%;margin:15px 25px}html body .cover .sidePane .adminLogin{background-color:#fff;width:400px;padding:30px;margin:auto}html body .cover .sidePane .adminLogin .heading{font-size:24px;font-weight:500}html body .cover .sidePane .adminLogin label{color:#666;display:inline-block;font-size:14px;font-weight:700;height:20px;line-height:20px;margin:15px 0;max-width:100%;outline-color:#333;outline-style:none;outline-width:0;padding:0;-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%}html body .cover .sidePane .adminLogin input{border-radius:4px;border:1px solid #ccc;box-sizing:border-box;color:#666;cursor:text;display:block;margin:0;padding:6px 12px;font-size:14px;font-stretch:100%;font-weight:400;height:34px;letter-spacing:normal;line-height:20px;text-align:start;text-shadow:none;-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%;text-transform:none;transition-delay:0s,1s;transition-duration:.15,.15s;transition-property:border-color,box-shadow;transition-timing-function:easein-out,ease-in-out;width:100%;word-spacing:0}html body .cover .sidePane .adminLogin .login1{width:100%;display:inline-block;margin:40px 0;background-color:#337ab7;border-radius:4px;font-size:14px;color:#fff;padding:6px 12px;line-height:20px;text-align:center}html body .cover .mainPane .heading{font-size:32px;display:inline-block;width:100%;text-align:center;vertical-align:middle;height:80px;padding:20px;font-weight:700;color:#4472c4}html body .cover .mainPane .container{width:950px!important;margin-top:60px}html body .cover .mainPane .container #dnxTable_wrapper{width:950px!important}html body .cover .mainPane .container #dnxTable_wrapper *{color:#666!important}html body .cover .mainPane .container #dnxTable_wrapper #dnxTable{width:950px!important}
</style>